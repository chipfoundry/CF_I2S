# EF_I2S
Two-wire I2S synchronous serial interface, compatible with I2S specification.
- Receiver only
- 32x32 Receive FIFO
- Sample Size selection
- Left channel, Right channel only or Stereo
- Programmable prescaler
- Suports both the classical I2S and the Left-aligned formats
- Programmable sample size
- Zero/Sign extension for the samples
- 
## The wrapped IP
 APB and AHBL wrappers, generated by the [IP_Utilities](https://github.com/shalan/IP_Utilities) `amba_wrap.py` utility, is provided. WB wrapper will be provided soon. All wrappers provide the same programmer's interface as outlined in the following sections.

### Wrapped IP System Integration

Based on your use case, use one of the provided wrappers or create a wrapper for your system bus type. For an example of how to integrate the APB wrapper:
```verilog
EF_I2S_APB INST (
        `TB_APB_SLAVE_CONN,
        .ws(ws)
        .sck(sck)
        .sdi(sdi)
        .sdo(sdo)
);
```
> **_NOTE:_** `TB_APB_SLAVE_CONN is a convenient macro provided by [IP_Utilities](https://github.com/shalan/IP_Utilities).

## Implementation example  

The following table is the result for implmenting the EF_I2S IP with different wrappers using Sky130 PDK and [yosys](https://github.com/YosysHQ/yosys).
|Module | Number of cells | Max. freq |
|---|---|---|
|EF_I2S|||
|EF_I2S_APB|||
|EF_I2S_AHBL|||
|EF_I2S_WB|||
## The Programming Interface


### Registers

|Name|Offset|Reset Value|Access Mode|Description|
|---|---|---|---|---|
|RXDATA|0000|0x00000000|r|The received sample|
|PR|0008|0x00000000|w|The Prescaler register; used to determine the sck signal frequency . $Prescaler = clk_freq/(2 x sck_freq) - 1$.|
|FIFOLEVEL|0008|0x00000000|r|The current receive FIFO level|
|RXFIFOT|0008|0x00000000|w|The FIFO threshold|
|CTRL|000c|0x00000000|w|Enable|
|CFG|0010|0x00003F08|w|0-1: Channels to read, '01': right, '10': left, '11': Both (stereo) 2: Sign Extend 3: Left Justify 4-8: Sample Size (0-31)|
|IM|0f00|0x00000000|w|Interrupt Mask Register; write 1/0 to enable/disable interrupts; check the interrupt flags table for more details|
|RIS|0f08|0x00000000|w|Raw Interrupt Status; reflects the current interrupts status;check the interrupt flags table for more details|
|MIS|0f04|0x00000000|w|Masked Interrupt Status; On a read, this register gives the current masked status value of the corresponding interrupt. A write has no effect; check the interrupt flags table for more details|
|IC|0f0c|0x00000000|w|Interrupt Clear Register; On a write of 1, the corresponding interrupt (both raw interrupt and masked interrupt, if enabled) is cleared; check the interrupt flags table for more details|

### RXDATA Register [Offset: 0x0, mode: r]

The received sample
<img src="https://svg.wavedrom.com/{reg:[{name:'RXDATA', bits:32},{bits: 0}], config: {lanes: 2, hflip: true}} "/>


### PR Register [Offset: 0x8, mode: w]

The Prescaler register; used to determine the sck signal frequency . $Prescaler = clk_freq/(2 x sck_freq) - 1$.

<img src="https://svg.wavedrom.com/{reg:[{name:'PR', bits:8},{bits: 24}], config: {lanes: 2, hflip: true}} "/>


### FIFOLEVEL Register [Offset: 0x8, mode: r]

The current receive FIFO level
<img src="https://svg.wavedrom.com/{reg:[{name:'FIFOLEVEL', bits:5},{bits: 27}], config: {lanes: 2, hflip: true}} "/>


### RXFIFOT Register [Offset: 0x8, mode: w]

The FIFO threshold

<img src="https://svg.wavedrom.com/{reg:[{name:'RXFIFOT', bits:5},{bits: 27}], config: {lanes: 2, hflip: true}} "/>


### CTRL Register [Offset: 0xc, mode: w]

Enable

<img src="https://svg.wavedrom.com/{reg:[{name:'CTRL', bits:1},{bits: 31}], config: {lanes: 2, hflip: true}} "/>


### CFG Register [Offset: 0x10, mode: w]

0-1: Channels to read, '01': right, '10': left, '11': Both (stereo) 2: Sign Extend 3: Left Justify 4-8: Sample Size (0-31)
<img src="https://svg.wavedrom.com/{reg:[{name:'channels', bits:2},{name:'sign_extend', bits:1},{name:'left_justified', bits:1},{name:'sample_size', bits:5},{bits: 23}], config: {lanes: 2, hflip: true}} "/>

|bit|field name|width|description|
|---|---|---|---|
|0|channels|2|Channels to read, '01': right, '10': left, '11': Both (stereo)|
|2|sign_extend|1|Sign Extend|
|3|left_justified|1||
|4|sample_size|5||


### Interrupt Flags

The wrapped IP provides four registers to deal with interrupts: IM, RIS, MIS and IC. These registers exist for all wrapper types generated by the [IP_Utilities](https://github.com/shalan/IP_Utilities) `amba_wrap.py` utility. 

Each register has a group of bits for the interrupt sources/flags.
- `IM`: is used to enable/disable inetrrupt sources.

- `RIS`: has the current interrupt status (interruot flags) whether they are enabled or diabled.

- `MIS`: is the result of masking (ANDing) RIS by IM.

- `IC`: is used to clear an inetrrupt flag.


The following are the bit definitions for the interrupt registers:

|Bit|Flag|Width|Description|
|---|---|---|---|
|0|FIFOE|1|FIFO is Empty.|
|1|FIFOA|1|FIFO level is above Threshold.|
|2|FIFOF|1|Receive FIFO is Full.|

### The Interface 


#### Ports 

|Port|Direction|Width|Description|
|---|---|---|---|
|ws|output|1|Word select (logic high on WS indicates right-channel audio)|
|sck|output|1|The data clock|
|sdi|input|1|The input serial data|
|sdo|output|1|The output serial data|
|ws|output|1|Word select (logic high on WS indicates right-channel audio)|
|sck|output|1|The data clock|
|sdi|input|1|The input serial data|
|sdo|output|1|The output serial data|
|fifo_rd|input|1|Read from FIFO signal|
|fifo_level_threshold|input|5|FIFO Threshold|
|fifo_full|output|1|FIFO is full flag|
|fifo_empty|output|1|FIFO is empty flag|
|fifo_level|output|5|The current FIFO level|
|fifo_level_above|output|1|FIFO level is above threshold flag|
|fifo_rdata|output|32|Data read from  FIFO|
|sign_extend|input|1|Flag to show if input data is sign extended|
|left_justified|input|1|Flag to show if input data is left justified|
|sample_size|input|5|The sample size of input data|
|sck_prescaler|input|8|The clock prescaler|
|channels|input|2|Channels used (left, right, or stereo)|
|en|input|1|Enable signal|
## F/W Usage Guidelines:
## Installation:
You can either clone repo or use [IPM](https://github.com/efabless/IPM) which is an open-source IPs Package Manager
* To clone repo:
```git clone https://github.com/efabless/EF_I2S```
* To download via IPM , follow installation guides [here](https://github.com/efabless/IPM/blob/main/README.md) then run 
```ipm install EF_I2S```
## Simulation:
### Run Verilog Testbench:
1. Clone [IP_Utilities](https://github.com/shalan/IP_Utilities) repo in the same directory as the IP
2. In the directory ``EF_I2S/verify/utb/`` run ``make APB-RTL`` to run testbench for APB or ``make AHBL-RTL`` to run textbench for AHBL
### Run cocotb UVM Testbench:
TBD
